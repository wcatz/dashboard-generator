{{define "content"}}
<h1 class="text-xl font-bold mb-1">datasources</h1>
<p class="text-sm text-base-content/50 mb-6">manage Prometheus connections for metric discovery</p>

<div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4">
  {{range $name, $ds := .Datasources}}
  <div class="card bg-base-100 border border-base-content/10">
    <div class="card-body p-5">
      <h3 class="card-title text-sm">{{$name}} {{if $ds.IsDefault}}<span class="badge badge-sm badge-success">default</span>{{end}}</h3>
      <table class="text-xs w-full">
        <tr><td class="text-base-content/50 w-16 py-1">type</td><td>{{$ds.Type}}</td></tr>
        <tr><td class="text-base-content/50 py-1">uid</td><td><code class="text-xs">{{$ds.UID}}</code></td></tr>
        <tr><td class="text-base-content/50 py-1">url</td><td>{{if $ds.URL}}<code class="text-xs">{{$ds.URL}}</code>{{else}}<span class="opacity-40">not set</span>{{end}}</td></tr>
      </table>
      {{if $ds.URL}}
      <div class="mt-3">
        <button class="btn btn-xs btn-outline" hx-get="/api/datasource/test?name={{$name}}" hx-target="#ds-status-{{$name}}" hx-indicator="#ds-spin-{{$name}}" hx-disabled-elt="this">
          test connection <span id="ds-spin-{{$name}}" class="htmx-indicator"><span class="spinner"></span></span>
        </button>
        <div id="ds-status-{{$name}}" class="mt-2 text-xs"></div>
      </div>
      {{end}}
    </div>
  </div>
  {{end}}
</div>

{{if not .Datasources}}
<div class="text-center py-12 text-base-content/50">
  <p>no datasources defined</p>
</div>
{{end}}

<div class="card bg-base-100 border border-base-content/10 mt-6">
  <div class="card-body p-5">
    <h3 class="card-title text-sm">add datasource URL</h3>
    <p class="text-xs text-base-content/50 mb-3">set the URL for an existing datasource to enable metric discovery</p>
    <form hx-post="/api/datasource/url" hx-target="#ds-url-result" hx-swap="innerHTML">
      <div class="flex flex-wrap gap-3 items-end">
        <label class="form-control flex-1 min-w-[150px]">
          <div class="label"><span class="label-text text-xs">datasource name</span></div>
          <select name="name" class="select select-bordered select-sm w-full">
            {{range $name, $ds := .Datasources}}
            <option value="{{$name}}">{{$name}}</option>
            {{end}}
          </select>
        </label>
        <label class="form-control flex-[2] min-w-[200px]">
          <div class="label"><span class="label-text text-xs">Prometheus URL</span></div>
          <input type="url" name="url" placeholder="http://prometheus:9090" required class="input input-bordered input-sm w-full">
        </label>
        <button type="submit" class="btn btn-sm btn-primary">set URL</button>
      </div>
    </form>
    <div id="ds-url-result" class="mt-2 text-sm"></div>
  </div>
</div>
{{end}}
