{{if .Error}}
<div class="alert alert-error text-sm">
  <span>{{.Error}}</span>
</div>
{{else}}
<div class="bg-base-200/50 rounded-lg p-4">
  <!-- stats row -->
  <div class="grid gap-2 mb-4" style="grid-template-columns: repeat(auto-fit, minmax(120px, 1fr))">
    <div class="bg-base-100 rounded-lg p-3 text-center border-t-2 border-success">
      <div class="text-xs text-base-content/50">shared by all</div>
      <div class="text-xl font-bold text-success">{{.SharedCount}}</div>
    </div>
    {{range .Datasources}}
    <div class="bg-base-100 rounded-lg p-3 text-center border-t-2 border-info">
      <div class="text-xs text-base-content/50 truncate" title="{{.}}">{{.}}</div>
      <div class="text-sm font-bold text-info">{{len (index $.Exclusive .)}}&nbsp;unique</div>
    </div>
    {{end}}
  </div>

  <!-- tabs -->
  <div role="tablist" class="tabs tabs-bordered mb-4 flex-wrap">
    <button role="tab" class="tab tab-active" onclick="showCompareAllTab('shared', this)">
      shared ({{.SharedCount}})
    </button>
    {{range $idx, $ds := .Datasources}}
    <button role="tab" class="tab" onclick="showCompareAllTab('exclusive-{{$ds}}', this)">
      {{$ds}} only ({{len (index $.Exclusive $ds)}})
    </button>
    {{end}}
  </div>

  <!-- shared tab with selection -->
  <div id="compare-all-tab-shared" class="compare-all-tab-content">
    {{if .Shared}}
    <form hx-post="/api/metrics/comparison-snippet" hx-target="#compare-all-snippet-result" hx-swap="innerHTML">
      {{range .Datasources}}
      <input type="hidden" name="datasources" value="{{.}}">
      {{end}}
      <div class="space-y-0.5 max-h-[500px] overflow-y-auto mb-3">
        {{range .Shared}}
        <label class="flex items-center gap-2 py-1 px-2 rounded hover:bg-base-100 cursor-pointer text-xs">
          <input type="checkbox" name="metrics" value="{{.Name}}" class="checkbox checkbox-xs checkbox-primary">
          <div class="flex-1 min-w-0">
            <span class="font-mono truncate block">{{.Name}}</span>
            {{if .Help}}<span class="text-base-content/40 truncate block text-[10px]">{{.Help}}</span>{{end}}
          </div>
          <span class="badge badge-xs badge-outline shrink-0">{{.Type}}</span>
        </label>
        {{end}}
      </div>
      <button type="submit" class="btn btn-xs btn-primary">generate comparison snippet</button>
    </form>
    {{else}}
    <div class="text-center py-6 text-base-content/50 text-xs">
      <p>no metrics shared by all datasources</p>
    </div>
    {{end}}
  </div>

  <!-- exclusive tabs -->
  {{range $ds := .Datasources}}
  <div id="compare-all-tab-exclusive-{{$ds}}" class="compare-all-tab-content" style="display:none">
    {{$metrics := index $.Exclusive $ds}}
    {{if $metrics}}
    <div class="space-y-0.5 max-h-[500px] overflow-y-auto">
      {{range $metrics}}
      <div class="flex items-center gap-2 py-1 px-2 rounded text-xs">
        <div class="flex-1 min-w-0">
          <span class="font-mono truncate block">{{.Name}}</span>
          {{if .Help}}<span class="text-base-content/40 truncate block text-[10px]">{{.Help}}</span>{{end}}
        </div>
        <span class="badge badge-xs badge-outline shrink-0">{{.Type}}</span>
      </div>
      {{end}}
    </div>
    {{else}}
    <div class="text-center py-6 text-base-content/50 text-xs">
      <p>no unique metrics for {{$ds}}</p>
    </div>
    {{end}}
  </div>
  {{end}}

  <div id="compare-all-snippet-result" class="mt-3"></div>
</div>
{{end}}
