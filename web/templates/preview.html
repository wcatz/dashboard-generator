{{define "content"}}
<h1>preview</h1>
<p class="subtitle">visual layout and JSON output</p>

<div class="card">
  <form hx-get="/api/preview" hx-target="#preview-result" hx-indicator="#preview-spinner">
    <div class="form-row">
      <label class="flex-1">
        dashboard
        <select name="uid" hx-get="/api/preview" hx-target="#preview-result" hx-indicator="#preview-spinner" hx-include="closest form">
          {{range .Dashboards}}
          <option value="{{.UID}}" {{if eq .UID $.SelectedUID}}selected{{end}}>{{.Title}}</option>
          {{end}}
        </select>
      </label>
      <button type="submit">
        preview <span id="preview-spinner" class="htmx-indicator"><span class="spinner"></span></span>
      </button>
    </div>
  </form>
</div>

<div id="preview-result">
  {{if .JSON}}
  <div class="card">
    <div class="card-header">
      <h3>{{.PreviewTitle}}</h3>
      <span class="text-sm text-secondary">{{.PreviewSize}} bytes &middot; {{.PreviewPanels}} panels</span>
    </div>

    <div class="tabs">
      <button class="preview-tab-btn active" data-tab="visual" onclick="togglePreviewTab('visual')">visual</button>
      <button class="preview-tab-btn" data-tab="json" onclick="togglePreviewTab('json')">JSON</button>
    </div>

    <div class="preview-tab-content active" data-tab="visual">
      {{if .PanelInfos}}
      <div class="preview-grid">
        {{range .PanelInfos}}
        {{if eq .Type "row"}}
        <div class="preview-row">{{.Title}}</div>
        {{else}}
        <div class="preview-panel type-{{.Type}}" style="grid-column: {{add .X 1}} / span {{.W}}; grid-row: auto / span {{.H}};">
          <div class="panel-header">
            <span class="panel-type-badge">{{.Type}}</span>
            <span class="panel-dims">{{.W}}x{{.H}}</span>
          </div>
          <div class="panel-title">{{.Title}}</div>
        </div>
        {{end}}
        {{end}}
      </div>
      {{else}}
      <div class="empty-state"><p>no panels found</p></div>
      {{end}}
    </div>

    <div class="preview-tab-content" data-tab="json">
      <div class="toolbar">
        <button class="sm ghost" onclick="copyToClipboard('json-output')">copy</button>
        <button class="sm ghost" onclick="downloadJSON('{{.PreviewTitle}}.json', 'json-output')">download</button>
      </div>
      <div class="json-preview" id="json-output">{{.JSON}}</div>
    </div>
  </div>
  {{else}}
  <div class="empty-state">
    <p>select a dashboard and click preview</p>
  </div>
  {{end}}
</div>
{{end}}
